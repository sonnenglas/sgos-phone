# Phone

Internal phone management system for voicemail processing.

## What It Does

1. **Syncs** voicemails from Placetel API
2. **Transcribes** audio using ElevenLabs speech-to-text
3. **Summarizes** transcripts with AI (sentiment, emotion, category, urgency)
4. **Emails** notifications via Postmark

### Processing Pipeline

```
Placetel → Sync → Download MP3 → Transcribe (ElevenLabs) → Summarize (AI) → Email (Postmark)
```

Each voicemail gets:
- **Transcription**: Full text from audio
- **Corrected text**: LLM-cleaned transcript
- **Summary**: In original language + English translation
- **Classification**: sentiment, emotion, category, priority

## Deployment

### Prerequisites

- Docker & Docker Compose
- Dokploy (or similar) for VPS deployment
- DOTENV_PRIVATE_KEY for encrypted secrets

### Quick Start (Local)

```bash
git clone https://github.com/stefanneubig/phone.git
cd phone

# Create .env.docker with decryption key
echo "DOTENV_PRIVATE_KEY=your-key-here" > .env.docker

# Start
docker compose up -d

# App runs at http://localhost:9000
```

### Production Deployment (Dokploy)

1. **Create Application** in Dokploy
   - Source: GitHub `stefanneubig/sgos.phone`
   - Branch: `main`
   - Build Type: Docker Compose
   - Compose File: `docker-compose.yml`

2. **Set Environment Variables** in Dokploy:
   ```
   DOTENV_PRIVATE_KEY=<from .env.keys file - never in git>
   BASE_URL=https://phone.sonnenglas.net
   EMAIL_FROM=phone@sonnenglas.net
   ```

3. **Configure Domain** in Dokploy:
   - Add domain: `phone.sonnenglas.net`
   - Enable HTTPS

4. **Deploy** - Click deploy. Dokploy will:
   - Pull from GitHub
   - Build Docker image
   - Start containers
   - Run database migrations automatically

5. **Configure Cloudflare** (optional):
   - Point domain to Dokploy server via Tunnel
   - Enable Zero Trust for authentication

6. **First-Time Setup** after deploy:
   - Go to `https://phone.sonnenglas.net/admin`
   - Set **Email Cutoff Date** to now (prevents emailing old voicemails)
   - Enable **Auto Send Emails** when ready

### Database

PostgreSQL runs in a separate container. Data persists in Docker volume.

Migrations run automatically on every startup via Alembic.

### Finding DOTENV_PRIVATE_KEY

The private key is in your local `.env.keys` file (auto-generated by dotenvx, never committed to git). Look for `DOTENV_PRIVATE_KEY=...`

## Configuration

### Settings (Admin UI at /admin)

| Setting | Default | Description |
|---------|---------|-------------|
| Sync Interval | 15 min | How often to fetch from Placetel |
| Auto Transcribe | On | Transcribe new voicemails automatically |
| Auto Summarize | On | Summarize after transcription |
| Auto Send Emails | Off | Email notifications after processing |
| Notification Email | — | Where to send voicemail emails |
| Email Cutoff Date | — | Only email voicemails after this date |

### Environment Variables

**Encrypted in `.env`** (secrets - decrypted at runtime by dotenvx):

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string |
| `PLACETEL_API_KEY` | Placetel API access |
| `ELEVENLABS_API_KEY` | ElevenLabs transcription |
| `OPENROUTER_API_KEY` | OpenRouter LLM for summaries |
| `POSTMARK_API_TOKEN` | Postmark email sending |
| `PUBLIC_ACCESS_SECRET` | Secret for token-based public links |

**Set in Dokploy** (not secrets - environment-specific):

| Variable | Default | Description |
|----------|---------|-------------|
| `BASE_URL` | http://localhost:9000 | Public URL for email links |
| `EMAIL_FROM` | — | Sender email (e.g., phone@domain.com) |
| `EMAIL_FROM_NAME` | Phone App | Sender name |
| `ALLOWED_EMAIL` | stefan@sonnenglas.net | Admin email for auth |
| `ENV` | production | Set to "development" to disable auth |

### Adding/Updating Secrets

```bash
# Encrypt a new variable
dotenvx set VARIABLE_NAME "value" -f .env

# The encrypted value is added to .env
# Commit .env (safe - it's encrypted)
```

## Authentication

In production, authentication uses **Cloudflare Zero Trust** headers:
- `stefan@sonnenglas.net` → Full admin access
- `*@sonnenglas.net` → View-only access (listen pages)
- Public listen pages use token-based auth (for email links)

In development (`ENV=development`), auth is disabled.

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/voicemails` | List voicemails |
| GET | `/voicemails/{id}` | Get single voicemail |
| GET | `/voicemails/{id}/audio` | Stream audio |
| GET | `/voicemails/{id}/email-preview` | Preview email HTML |
| DELETE | `/voicemails/{id}` | Delete voicemail |
| POST | `/voicemails/{id}/transcribe` | Transcribe one |
| POST | `/voicemails/{id}/summarize` | Summarize one |
| GET | `/settings` | Get all settings |
| PUT | `/settings/{key}` | Update setting |
| POST | `/settings/sync-now` | Manual sync |
| POST | `/settings/reprocess/{id}` | Re-transcribe + summarize + email |
| POST | `/settings/send-email/{id}` | Manually send email |
| GET | `/listen/{id}?token=xxx` | Public voicemail player |
| GET | `/health` | Health check |

Full API docs at `/docs` (Swagger UI)

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Phone App                             │
├─────────────────────────────────────────────────────────────┤
│  Frontend (React)          │  Backend (FastAPI)              │
│  ├─ Voicemail list         │  ├─ REST API                    │
│  ├─ Voicemail detail       │  ├─ Background scheduler        │
│  └─ Settings               │  └─ Email service (Postmark)    │
├─────────────────────────────────────────────────────────────┤
│  Background Jobs (APScheduler)                               │
│  ├─ Sync from Placetel (every N minutes)                    │
│  ├─ Transcribe pending (ElevenLabs)                         │
│  ├─ Summarize & classify (OpenRouter)                       │
│  └─ Send email notifications (Postmark)                     │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL                                                  │
│  ├─ calls table (voicemails)                                │
│  └─ settings table (config)                                 │
└─────────────────────────────────────────────────────────────┘
```

## Tech Stack

- **Backend**: Python 3.13, FastAPI, SQLAlchemy 2.0, APScheduler
- **Frontend**: React 18, TypeScript, Tailwind CSS, Vite
- **Database**: PostgreSQL
- **Transcription**: ElevenLabs Scribe v2
- **Summarization**: OpenRouter (configurable model)
- **Email**: Postmark
- **Secrets**: dotenvx (encrypted .env)
- **Auth**: Cloudflare Zero Trust

## Development

```bash
# Backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
dotenvx run -- uvicorn app.main:app --reload

# Frontend (separate terminal)
cd frontend
npm install
npm run dev
```

## Files

```
├── app/
│   ├── main.py           # FastAPI app, routes, middleware
│   ├── config.py         # Environment config
│   ├── database.py       # SQLAlchemy setup
│   ├── models.py         # Database models
│   ├── schemas.py        # Pydantic schemas
│   ├── routers/
│   │   ├── calls.py      # Voicemail endpoints
│   │   ├── sync.py       # Sync/transcribe/summarize
│   │   ├── settings.py   # Settings CRUD
│   │   └── webhook.py    # Placetel webhook
│   └── services/
│       ├── placetel.py   # Placetel API client
│       ├── elevenlabs.py # Transcription
│       ├── openrouter.py # LLM summarization
│       ├── email.py      # Postmark email
│       ├── scheduler.py  # Background jobs
│       └── access_token.py # Token generation
├── frontend/             # React app
├── alembic/              # Database migrations
├── docker-compose.yml
├── Dockerfile
└── .env                  # Encrypted secrets
```

## License

Proprietary - Stefan Neubig
